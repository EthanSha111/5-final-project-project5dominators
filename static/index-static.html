<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SPA Layout</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link href="index.css" rel="stylesheet" type="text/css">

    </head>
    <body>
        <div class="grid-container">
            <div class="header">
                <div class="logo">Snap&Chat</div>
                <div>Sign out</div>
            </div>

            <!-- Outer div is reversed to scoll up instead of down -->
            <div class="chatroom">
                <!-- Inner div to reverse back content to correct order -->
                <div> 

                    <!-- TODO: Populate the messages dynamically from database by using a loop -->

                    <div class="message">
                        <img src="placeholder.jpg" alt="User" class="user-photo">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="username">Username</span>
                                <button class="delete-btn">Delete</button>
                            </div>
                            <p class="message-text">(Oldest Message) Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>
                        </div>
                    </div>

                    <div class="message">
                        <img src="placeholder.jpg" alt="User" class="user-photo">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="username">Username</span>
                                <button class="delete-btn">Delete</button>
                            </div>
                            <p class="message-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>
                        </div>
                    </div>

                    <div class="message">
                        <img src="placeholder.jpg" alt="User" class="user-photo">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="username">Username</span>
                                <button class="delete-btn">Delete</button>
                            </div>
                            <p class="message-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Orci sagittis eu volutpat odio facilisis mauris sit amet massa. Tellus in hac habitasse platea dictumst vestibulum rhoncus est. At erat pellentesque adipiscing commodo elit at. Vitae aliquet nec ullamcorper sit amet. Consequat semper viverra nam libero. Volutpat ac tincidunt vitae semper quis lectus nulla. Lorem dolor sed viverra ipsum nunc aliquet bibendum enim. Vestibulum morbi blandit cursus risus at ultrices mi. Dolor sit amet consectetur adipiscing elit duis.

                                Ac orci phasellus egestas tellus. Euismod in pellentesque massa placerat duis ultricies lacus sed turpis. Dolor sit amet consectetur adipiscing elit ut aliquam purus. Aliquam vestibulum morbi blandit cursus risus at ultrices mi tempus. Nec feugiat nisl pretium fusce id velit ut tortor. Morbi tristique senectus et netus et malesuada fames. Eu mi bibendum neque egestas congue quisque egestas diam. Dolor morbi non arcu risus quis varius quam quisque id. Donec et odio pellentesque diam. Elit pellentesque habitant morbi tristique senectus et netus et malesuada.
                                
                                Eget mi proin sed libero enim sed. Platea dictumst vestibulum rhoncus est pellentesque elit ullamcorper dignissim. Id aliquet lectus proin nibh nisl condimentum id venenatis a. Id ornare arcu odio ut sem nulla pharetra. Cursus euismod quis viverra nibh cras pulvinar mattis. Vestibulum rhoncus est pellentesque elit ullamcorper dignissim. Tincidunt praesent semper feugiat nibh sed pulvinar proin. Dapibus ultrices in iaculis nunc sed augue lacus. Netus et malesuada fames ac turpis egestas integer. Interdum posuere lorem ipsum dolor sit amet consectetur adipiscing. Libero nunc consequat interdum varius sit amet mattis vulputate enim.
                                
                                Justo donec enim diam vulputate ut. Accumsan tortor posuere ac ut. Id velit ut tortor pretium viverra suspendisse potenti. In fermentum posuere urna nec. Orci nulla pellentesque dignissim enim sit amet venenatis urna cursus. Dui ut ornare lectus sit amet est placerat in egestas. Augue lacus viverra vitae congue eu consequat ac. Malesuada fames ac turpis egestas maecenas. Nulla aliquet enim tortor at auctor urna nunc id. Donec adipiscing tristique risus nec feugiat in fermentum posuere urna. Blandit turpis cursus in hac habitasse platea dictumst quisque.</p>
                        </div>
                    </div>

                    <div class="message">
                        <img src="placeholder.jpg" alt="User" class="user-photo">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="username">Username</span>
                                <button class="delete-btn">Delete</button>
                            </div>
                            <p class="message-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>
                        </div>
                    </div>

                    <div class="message">
                        <img src="placeholder.jpg" alt="User" class="user-photo">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="username">Username</span>
                                <button class="delete-btn">Delete</button>
                            </div>
                            <p class="message-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Orci sagittis eu volutpat odio facilisis mauris sit amet massa. Tellus in hac habitasse platea dictumst vestibulum rhoncus est. At erat pellentesque adipiscing commodo elit at. Vitae aliquet nec ullamcorper sit amet. Consequat semper viverra nam libero. Volutpat ac tincidunt vitae semper quis lectus nulla. Lorem dolor sed viverra ipsum nunc aliquet bibendum enim. Vestibulum morbi blandit cursus risus at ultrices mi. Dolor sit amet consectetur adipiscing elit duis.</p>
                        </div>
                    </div>

                    <div class="message">
                        <img src="placeholder.jpg" alt="User" class="user-photo">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="username">Username</span>
                                <button class="delete-btn">Delete</button>
                            </div>
                            <p class="message-text">(Latest Message) Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore...</p>
                        </div>
                    </div>

                </div>
            </div>

            <div class="camera">
                <div>
                    <div class="col-md-4">
                        <video id="video" autoplay></video>
                        <canvas id="canvas" width="480" height="480" style="display: none;"></canvas>
                    </div>                
                </div>
            </div>

            <div class="footer">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="capture">Send/Snap</button>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

        <script>
            // Scroll to the bottom of the chatroom
            document.addEventListener("DOMContentLoaded", function() {
                var chatContainer = document.getElementByClassName('chatroom');
                chatContainer.scrollTo(0, chatContainer.scrollHeight);
            });

            // Access the user's camera and display the feed
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    isCameraActive = true; // Camera is active
                    $('#send-button').prop('disabled', false); // Enable the send button
                })
                .catch(err => {
                    console.error("Error accessing camera: ", err);
                    alert("Identity matters. You won't be able to send messages without camera access. ")
                    isCameraActive = false; // Camera is not active
                    $('#send-button').prop('disabled', true); // Disable the send button
                });
    
            // Capture the image and send it to the backend
            document.getElementById('capture').addEventListener('click', function() {
                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');
                const video = document.getElementById('video');
                var input = document.getElementById('message-input');
                var message = input.value.trim();

                if (!isCameraActive) {
                    alert("Camera is not active. Please refresh and allow camera access to send messages.");
                    return; // Stop the function from proceeding further
                }

                if (message.length === 0) {
                    // If the message is empty, do not send it and possibly alert the user
                    alert("Please enter a message."); // You can replace this with a more subtle notification
                    return; // Stop the function from proceeding further
                }
    
                // Calculate the dimensions to crop the video to a square
                let videoWidth = video.videoWidth;
                let videoHeight = video.videoHeight;
                let startX = 0;
                let startY = 0;
                let squareLength = Math.min(videoWidth, videoHeight);
    
                if (videoWidth > videoHeight) {
                    startX = (videoWidth - videoHeight) / 2;
                } else {
                    startY = (videoHeight - videoWidth) / 2;
                }
    
                // Draw the cropped video frame to the canvas
                context.drawImage(video, startX, startY, squareLength, squareLength, 0, 0, canvas.width, canvas.height);
    
                // Convert canvas to Data URL
                var imageDataUrl = canvas.toDataURL('image/png');
    
                // Send the image data to the backend
                $.ajax({
                    type: "POST",
                    url: "/path/to/backend", // Replace with your server URL
                    data: {
                        image: imageDataUrl
                    },
                    success: function(response) {
                        console.log("Image sent successfully");
                    },
                    error: function(error) {
                        console.error("Error sending image", error);
                    }
                });

                // Send the message to the backend
                $.ajax({
                    type: "POST",
                    url: "/path/to/backend", // Replace with your server URL
                    data: {
                        message: message
                    },
                    success: function(response) {
                        console.log("Message sent successfully");
                    },
                    error: function(error) {
                        console.error("Error sending message", error);
                    }
                });

                // Clear the input field
                input.value = "";
                $('#send-button').prop('disabled', true); // Disable the send button

            });
        </script>

    </body>
</html>
